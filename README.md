# Distro Rating Bot

Telegram-бот на **Python** и **aiogram v3** для учета продаж, рейтингов и мотивационных механик.

Актуальные роли:
- **ADMIN** - глобальные административные функции.
- **MANAGER** - управление своими организациями и операциями.
- **ROP** - роль руководителя отдела продаж внутри организации.
- **SELLER** - продавец.

---

## Содержание

- [Что изменилось (2026-02)](#что-изменилось-2026-02)
- [Возможности](#возможности)
- [Безопасность и надежность](#безопасность-и-надежность)
- [Быстрый старт](#быстрый-старт)
- [Настройка `.env`](#настройка-env)
- [Сценарии ролей](#сценарии-ролей)
- [Интеграция с 1С](#интеграция-с-1с)
- [Модуль 1С (подробно)](#модуль-1с-подробно)
- [Расписание задач](#расписание-задач)
- [Тестовые данные](#тестовые-данные)
- [Устранение неполадок](#устранение-неполадок)

---

## Что изменилось (2026-02)

Проект обновлен по `docs/implementation-checklist.md` и `docs/implementation-checklist2.md`.

Ключевые изменения:
- Полный RBAC: `ADMIN` / `MANAGER` / `ROP` / `SELLER`, регистрация с выбором роли.
- Для организаций используются **два пароля**: отдельно для `SELLER` и `ROP`.
- Регистрация пользователя: **ИНН -> роль -> пароль роли -> ФИО -> никнейм**.
- Добавлены: споры по продажам, модерация споров `ROP`, двухшаговые подтверждения с таймером.
- Добавлен раздел "Финансы": медкоины, заморозка в спорах, вывод средств, помесячная статистика.
- Добавлены "Личные цели": бассейн, бонус за новый ИНН, сверхзадачи (включая Excel), среднемесячные уровни.
- Для `ROP`: раздел "Мои сотрудники", карточка сотрудника, экспорт продаж сотрудника в Excel.
- Для `MANAGER/ADMIN`: смена ИНН, слияние компаний (admin-only), улучшенная работа с организациями.
- Пуши после синхронизации 1С отправляются только при реально новых продажах (`inserted_count > 0`) и только релевантным активным пользователям.
- Расчеты рейтингов, челленджей и бонусов завязаны на **дату продажи** (`turnover.period`), а не на дату фиксации.
- Усилен контур безопасности и атомарности (tenant isolation, anti double-spend, private-only, rate limit, шифрование реквизитов).
- Меню для ролей теперь строго role-aware: `SELLER`/`ROP` и `MANAGER`/`ADMIN` видят только допустимые пункты.
- В поддержке добавлен антиспам-флоу: текст обращения -> подтверждение -> таймер 60 секунд -> отправка.
- Для рассылки добавлен режим "по выбранной компании" с ограничением области доступа.

---

## Возможности

### ADMIN / MANAGER

- Создание организаций с двумя паролями (`SELLER`/`ROP`) и учетом ИНН в `org_inns`.
- Карточка организаций, безопасный сброс паролей, просмотр сотрудников.
- Синхронизация оборотов из 1С (текущий месяц или период до 60 дней).
- Выгрузка рейтингов в Excel.
- Рассылка продавцам (всем, по доступным организациям, либо по выбранной компании).
- Смена ИНН организации (`MANAGER`/`ADMIN`).
- Слияние компаний (`ADMIN` only), перенос ИНН и пользователей в мастер-группу.
- Админ-раздел "Личные цели": сверхзадачи, среднемесячные уровни, шаблоны и импорт.

### SELLER / ROP

- Регистрация в компании по ИНН и паролю роли.
- Фиксация продаж из списка незакрепленных (с учетом `BOT_LAUNCH_DATE` и границ своей группы компаний).
- Профиль, рейтинг в компании, челленджи и лига по внутрикомпанейскому рангу.
- Оспаривание продаж:
  - доступные споры;
  - мои споры;
  - споры против меня;
  - модерация споров для `ROP`.
- Финансы:
  - доступный/замороженный/заработанный/выведенный баланс;
  - вывод средств с реквизитами и подтверждением;
  - помесячная статистика и детализация начислений.
- Личные цели:
  - бассейн (`POOL_*`);
  - бонус за новый ИНН покупателя;
  - сверхзадачи;
  - среднемесячные уровни.
- Для `ROP`: "Мои сотрудники", карточки и Excel-экспорт продаж сотрудников.

### Общее

- Аудит действий (`audit_log`) и runtime-логи с ротацией (`LOG_PATH`).
- Тихие часы уведомлений (`QUIET_HOURS_START` / `QUIET_HOURS_END`).
- PDF "Правила и рекомендации" из `RULES_FILE_PATH`.
- Техподдержка через `SUPPORT_USERNAME` или `SUPPORT_USER_ID`.
- При обращении в поддержку доступен flow с подтверждением и таймером отправки.

---

## Безопасность и надежность

Внедрены и проверены:
- Private-only режим для пользовательских и менеджерских роутеров.
- In-memory rate limit для критичных сценариев (регистрация, споры, вывод).
- Tenant-изоляция и повторные проверки в confirm-шаге споров.
- Усиленный RBAC в критичных действиях увольнения/восстановления `ROP`.
- Атомарный вывод средств (защита от double-spend).
- Атомарность открытия/разрешения споров.
- Корректная обработка гонок при фиксации продажи (`sqlite3.IntegrityError`).
- Шифрование чувствительных реквизитов "at rest" с обратной совместимостью.
- Безопасная отправка секретов (пароли) в чат менеджера с авто-удалением.
- Очистка временных `.xlsx` файлов в `finally`.
- Корректное завершение планировщика при остановке бота (`scheduler.shutdown(wait=True)`).

---

## Быстрый старт

### 1) Требования

- Python 3.10+
- Доступ в интернет (Telegram API; опционально 1С по HTTP)

### 2) Установка

```bash
git clone https://github.com/deadsmokeprod/Distro-Rating-Bot.git
cd Distro-Rating-Bot
python -m venv .venv
```

Windows (PowerShell):
```powershell
.\.venv\Scripts\Activate.ps1
```

Linux/macOS:
```bash
source .venv/bin/activate
```

Установка зависимостей:
```bash
pip install -r requirements.txt
```

### 3) Настройка окружения

```bash
copy .env.example .env
```

Заполните минимум:
- `BOT_TOKEN`
- `MANAGER_IDS` (или `ADMIN_IDS`, если используете admin)
- `SUPPORT_USER_ID`

### 4) Запуск

```bash
python bot.py
```

Остановка: `Ctrl+C`.

---

## Настройка `.env`

Все параметры и значения по умолчанию см. в `.env.example`.

### Обязательные

- `BOT_TOKEN`
- `SUPPORT_USER_ID`

### Роли и доступ

- `ADMIN_IDS`
- `MANAGER_IDS`
- `ROP_LIMIT_PER_ORG`

### UI и сценарии

- `INLINE_PAGE_SIZE`
- `RATING_WINDOW_SIZE`
- `RULES_FILE_PATH`

### Антиспам и cooldown

- `SALE_CONFIRM_LIMIT`
- `SALE_CONFIRM_WINDOW_SEC`
- `SALE_CONFIRM_ACTION_COOLDOWN_SEC`
- `SALE_CONFIRM_GLOBAL_COOLDOWN_SEC`
- `DISPUTE_OPEN_LIMIT`
- `DISPUTE_OPEN_WINDOW_SEC`
- `DISPUTE_OPEN_ACTION_COOLDOWN_SEC`
- `DISPUTE_OPEN_GLOBAL_COOLDOWN_SEC`
- `MERGE_EXECUTE_LIMIT`
- `MERGE_EXECUTE_WINDOW_SEC`
- `MERGE_EXECUTE_ACTION_COOLDOWN_SEC`
- `MERGE_EXECUTE_GLOBAL_COOLDOWN_SEC`
- `SUPPORT_SEND_COOLDOWN_SEC`
- `MANAGER_HELP_SEND_COOLDOWN_SEC`

### Интеграция с 1С

- `ONEC_URL`
- `ONEC_OPERATION_TYPE`
- `ONEC_USERNAME`
- `ONEC_PASSWORD`
- `ONEC_TIMEOUT_SECONDS`

### Пуши и уведомления

- `SYNC_PUSH_ENABLED`
- `DISPUTE_PUSH_ENABLED`
- `SUPERTASK_PUSH_NEW_ENABLED`
- `SUPERTASK_PUSH_DONE_ENABLED`
- `QUIET_HOURS_START`
- `QUIET_HOURS_END`

### Расчеты и бонусы

- `BOT_LAUNCH_DATE`
- `POOL_DAYS`
- `POOL_MEDCOIN_PER_LITER`
- `NEW_BUYER_BONUS`
- `CHALLENGE_GROWTH_PCT`
- `CHALLENGE_BASE_VOLUME`
- `AVG_WINDOW_MONTHS`
- `AVG_ADD_PCT`
- `AVG_IGNORE_INITIAL_ZERO_MONTHS`
- `MAX_AVG_LEVELS`

### Пути

- `DB_PATH`
- `LOG_PATH`

---

## Сценарии ролей

### ADMIN / MANAGER

1. `/start` -> вход в менеджерское меню.
2. Создание организации (ИНН + наименование) -> выдаются пароли `SELLER` и `ROP`.
3. При необходимости:
   - синхронизация с 1С;
   - выгрузка рейтингов;
   - смена ИНН;
   - слияние компаний (`ADMIN`);
   - управление личными целями.

### SELLER / ROP

1. `/start` -> регистрация: ИНН -> роль -> пароль роли -> ФИО -> никнейм.
2. Фиксация продаж.
3. Просмотр рейтинга и профиля.
4. Работа со спорами.
5. Работа с финансами и выводом.
6. Для `ROP`: раздел "Мои сотрудники".

---

## Интеграция с 1С

Бот отправляет `POST` на `ONEC_URL` с JSON:

```json
{
  "startDate": "YYYY-MM-DD",
  "endDate": "YYYY-MM-DD",
  "operationType": "Передача между УОТ",
  "ТипОперации": "Передача между УОТ"
}
```

Ожидается JSON-ответ с `ok`, `count`, `rows`.

Если 1С опубликована с Basic Auth, используйте `ONEC_USERNAME` и `ONEC_PASSWORD`.
При ошибках бот показывает безопасную причину и подсказку (например, для `401`: проверить auth-режим публикации и права пользователя 1С).

Подробный пример модуля 1С и рекомендации см. в истории проекта и документах:
- `docs/dev-2-18-02-25.extracted.md`
- `docs/implementation-checklist.md`

---

## Модуль 1С (подробно)

Стабильная документация по модулю 1С перенесена в проект:

- `docs/onec-http-module-guide.md`

В документе есть:

- схема публикации и правильный URL `/hs/BotAPI/chz_turnover`;
- контракт API (request/response/error);
- требования к пользователю `bot_api` и правам/RLS;
- логика обработчика 1С и чек-лист диагностики `400/401/403/404/500`;
- практические подсказки по `operationType` и `availableOperationTypes`.

---

## Расписание задач

Все задачи выполняются по времени МСК.

| Задача | Расписание | Описание |
|---|---|---|
| Синхронизация с 1С | Воскресенье 04:00 | Обороты за последние 30 дней (если задан `ONEC_URL`). |
| Месячный снапшот | 1-е число 00:10 | Снимок рейтингов за прошлый месяц. |
| Челленджи | 1-е и 15-е число 00:05 | Инициализация/обновление 2-недельных челленджей. |
| Напоминания | Ежедневно 10:00 | Напоминания активным продавцам (с учетом тихих часов). |

---

## Тестовые данные

Для проверки без 1С:

```bash
python seed_test_turnover.py
```

Скрипт заполняет `chz_turnover` тестовыми записями.

Для проверки фиксации продаж:
1. Создайте организацию с ИНН `4611012110`.
2. Зарегистрируйте `SELLER` или `ROP` в этой организации.
3. Откройте раздел фиксации продаж.

Smoke-проверка Stage 7 (техрегресс):

```bash
python scripts/stage7_smoke.py
```

---

## Устранение неполадок

- `BOT_TOKEN is required`  
  Проверьте заполнение `BOT_TOKEN` в `.env`.

- `Conflict: terminated by other getUpdates request`  
  С этим токеном уже запущен другой экземпляр. Остановите его.

- Не работает синхронизация с 1С  
  Проверьте `ONEC_URL`, сеть, auth, формат ответа 1С. Для `401` проверьте `ONEC_USERNAME`/`ONEC_PASSWORD` и режим публикации HTTP-сервиса (анонимный vs Basic Auth).

- Нет кнопок менеджера  
  Проверьте, что ваш Telegram ID есть в `MANAGER_IDS` или `ADMIN_IDS`.

- Пользователь не может писать боту в группе  
  Это ожидаемо: включен private-only режим.

---

## Лицензия и репозиторий

Проект: [Distro-Rating-Bot](https://github.com/deadsmokeprod/Distro-Rating-Bot)
