# Distro Rating Bot

Telegram-бот на **aiogram v3** для двух ролей: менеджер и продавец. Менеджер регистрирует организации и управляет их данными, продавцы регистрируются по ИНН и паролю, фиксируют продажи и получают рейтинги.

## Возможности

### Менеджер
- Регистрация организаций и выдача паролей продавцам.
- Сброс пароля организации.
- Обновление базы продаж из 1С (текущий месяц или произвольный период).
- Автообновление базы продаж по расписанию (воскресенье 04:00 МСК).
- Снапшоты рейтингов по месяцам (1‑е число месяца 00:10 МСК).
- Выгрузка рейтингов в Excel за период + текущий месяц.

### Продавец
- Регистрация по ИНН, паролю и ФИО.
- Фиксация продаж (по списку продаж организации, только незакреплённые).
- Профиль с рейтингами и сравнением с прошлым месяцем.
- Мировой рейтинг текущего месяца.
- Рейтинг компании за текущий месяц.

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Настройка окружения

1. Скопируйте `.env.example` в `.env`.
2. Заполните переменные:

| Переменная | Описание |
| --- | --- |
| `BOT_TOKEN` | Токен Telegram-бота |
| `MANAGER_IDS` | Список Telegram ID менеджеров через запятую (пробелы игнорируются) |
| `SUPPORT_USER_ID` | Telegram ID техподдержки |
| `SUPPORT_USERNAME` | Опционально. Username техподдержки в Telegram (без @) — тогда под сообщениями появится кнопка «Написать в техподдержку», открывающая чат. Если не указан, по нажатию бот уведомит поддержку о запросе. |
| `ONEC_URL` | URL HTTP сервиса 1С для загрузки оборотов (POST JSON `{startDate,endDate}`) |
| `CHALLENGE_GROWTH_PCT` | Рост цели челленджа относительно прошлого месяца (в процентах) |
| `CHALLENGE_BASE_VOLUME` | Базовая цель (литры), если прошлый месяц был 0 |
| `QUIET_HOURS_START` | Начало тихих часов (МСК), например `19:00` |
| `QUIET_HOURS_END` | Конец тихих часов (МСК), например `08:00` |
| `DB_PATH` | Путь к SQLite базе |
| `LOG_PATH` | Путь к файлу логов |

## Запуск

```bash
python bot.py
```

## Проверка токена и окружения

```bash
python verify.py
```

## Где хранится база

SQLite база находится по пути `DB_PATH` (по умолчанию `./data/bot.sqlite3`). Папка `data/` создаётся автоматически.

## Интеграция с 1С

Запрос выполняется POST JSON:
```json
{
  "startDate": "YYYY-MM-DD",
  "endDate": "YYYY-MM-DD"
}
```

## Фиксация продаж продавцом

Продавцу показываются только продажи:
- относящиеся к организации, где он зарегистрирован;
- ещё не зафиксированные кем-либо.

После подтверждения продажа закрепляется за продавцом, а рейтинг пересчитывается.

## Рейтинги

- Рейтинг за всё время хранится в `ratings_all_time` и пересчитывается при фиксации продаж.
- Месячные рейтинги хранятся в `ratings_monthly` (снапшоты по календарным месяцам).
- Текущий месяц считается «на лету».

## Геймификация

- Челленджи на 2 недели: цель = прошлый месяц + `CHALLENGE_GROWTH_PCT%`, минимум `CHALLENGE_BASE_VOLUME`.
- Прогресс отображается в главном меню и профиле.
- Лиги по процентилям мирового рейтинга текущего месяца (Duolingo‑стиль).
- Напоминания: если не заходил 3+ дня, потерял место, близкий конкурент в компании.

## Экспорт рейтингов в Excel

Менеджер вводит период строго в формате:
```
с ММ ГГГГ по ММ ГГГГ
```

Файл содержит 2 листа:
- `Снапшоты` — данные `ratings_monthly` за выбранный период.
- `Текущий месяц` — расчёт на лету.

Колонки:
`Период, Пользователь id, Пользователь ФИО, ИНН организации, Наименование организации, Рейтинг, Место в рейтинге мировом, Место в рейтинге компании`.

## Тестовые данные

Для проверки можно загрузить тестовые продажи:
```bash
python seed_test_turnover.py
```

## Если продавец не может войти

Менеджеру нужно сбросить пароль организации в карточке организации и передать новый пароль продавцу.
