# MJOLNIR RATE DISTR — Telegram-бот рейтинга дистрибьютеров

Этот проект — Telegram-бот для:
- рейтинга дистрибьютеров по объёму продаж,
- личного рейтинга сотрудников,
- фиксации продаж,
- технической поддержки через форум-треды Telegram,
- синхронизации данных из 1С:ERP по HTTP.

## Что нужно подготовить заранее
1. **Telegram Bot Token** — получить через BotFather.
2. **ID группы поддержки** с включёнными Forum Topics (форум-треды) + выдать боту права на создание/удаление тем.
3. (Опционально) **Доступ к HTTP-сервису 1С** (URL, логин, пароль).

---

## ПЕРВЫЙ ЗАПУСК на Windows 11 (для новичков)

1. Установите **Python 3.11+** с сайта https://python.org
   - ОБЯЗАТЕЛЬНО поставьте галочку **Add python to PATH**.
2. Скачайте/распакуйте проект в удобную папку.
3. Откройте **PowerShell** в папке проекта.
4. Создайте виртуальное окружение:
   ```powershell
   python -m venv .venv
   ```
5. Активируйте окружение:
   ```powershell
   .\.venv\Scripts\activate
   ```
6. Установите зависимости:
   ```powershell
   pip install -r requirements.txt
   ```
7. Создайте файл **.env** из **.env.example** и заполните значения.
8. Убедитесь, что в корне есть файл **1cerpsql** (он уже в репозитории).
9. Запустите бота:
   ```powershell
   python -m bot.main
   ```
10. Проверка: откройте бота в Telegram → `/start` → пройдите регистрацию.

---

## ПОСЛЕДУЮЩИЕ ЗАПУСКИ

**Вариант 1 (вручную):**
```powershell
.\.venv\Scripts\activate
python -m bot.main
```

**Вариант 2 (скриптом):**
```
 scripts\run_windows.bat
```

---

## ОБНОВЛЕНИЕ ПРОЕКТА

**Если проект получен через git:**
```powershell
git pull
pip install -r requirements.txt
```

**Если без git:**
1. Скачайте новую версию проекта.
2. Перенесите файл **data/database.sqlite3** и **.env** в новую папку.

---

## РЕЗЕРВНОЕ КОПИРОВАНИЕ

Просто копируйте файл базы:
```
./data/database.sqlite3
```

---

## ТИПИЧНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ

- **"python не найден"** → переустановите Python и отметьте галочку PATH.
- **"BOT_TOKEN invalid"** → проверьте правильность токена.
- **"message thread not found / TOPIC_ID_INVALID"** → тред закрыт → создайте новое обращение.
- **Нет прав на создание тредов** → выдать права боту в группе поддержки.
- **1С не отвечает** → проверьте ERP_HTTP_URL/доступ/лог.

---

## Где лежат логи

Лог-файл:
```
logs/app.log
```

---

## Быстрые команды

- Создать окружение и установить зависимости:
```
 scripts\setup_windows.bat
```

- Запуск:
```
 scripts\run_windows.bat
```
