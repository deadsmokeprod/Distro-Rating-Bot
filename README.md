# MJOLNIR RATE DISTR — Telegram-бот рейтингов дистрибьютеров

Бот помогает:
- вести рейтинг дистрибьютеров по объёму продаж;
- считать личный рейтинг сотрудников по «зафиксированным» продажам;
- принимать обращения в техподдержку через forum topics в Telegram.

## Что нужно заранее подготовить
1. **Telegram Bot Token** — получить у BotFather.
2. **Группа поддержки** в Telegram с включёнными **Forum Topics** и правами бота на создание тем.
3. (Опционально) **доступ к HTTP-сервису 1С:ERP**: URL, логин/пароль.

## Первый запуск на Windows 11 (с нуля)
1. Установите **Python 3.11+** с официального сайта и **обязательно** поставьте галочку «Add python to PATH».
2. Скачайте и распакуйте проект в удобную папку.
3. Откройте **PowerShell** в папке проекта.
4. Создайте виртуальное окружение:
   ```powershell
   python -m venv .venv
   ```
5. Активируйте окружение:
   ```powershell
   .\.venv\Scripts\activate
   ```
6. Установите зависимости:
   ```powershell
   pip install -r requirements.txt
   ```
7. Создайте файл `.env` из `.env.example` и заполните значения.
8. Убедитесь, что файл `1cerpsql` уже лежит в корне проекта.
9. Запустите бота:
   ```powershell
   python -m bot.main
   ```
10. Проверьте работу: откройте бота в Telegram → `/start` → регистрация.

## Последующие запуски
**Вариант 1 (ручной):**
1. Откройте папку проекта.
2. Активируйте окружение:
   ```powershell
   .\.venv\Scripts\activate
   ```
3. Запустите:
   ```powershell
   python -m bot.main
   ```

**Вариант 2 (скрипт):**
- `scripts\run_windows.bat`

## Обновление проекта
**Если используете git:**
```powershell
git pull
pip install -r requirements.txt
```

**Если не используете git:**
1. Скачайте новую версию проекта.
2. Перенесите `data/database.sqlite3` и `.env` в новую папку.

## Резервное копирование
Достаточно копировать файл базы:
```
/data/database.sqlite3
```

## Типичные ошибки и решения
- **«python не найден»** → переустановите Python и включите «Add python to PATH».
- **«BOT_TOKEN invalid»** → проверьте токен в `.env`.
- **«message thread not found / TOPIC_ID_INVALID»** → обращение было закрыто → создайте новое.
- **Нет прав на создание тредов** → выдайте права боту в группе поддержки.
- **1С не отвечает** → проверьте `ERP_HTTP_URL`, доступ и логи.

## Где лежат логи
Логи пишутся в файл:
```
logs/app.log
```

## Структура проекта (кратко)
- `bot/` — основной код.
- `bot/db/` — модели и работа с SQLite.
- `bot/routers/` — обработчики команд и кнопок.
- `bot/services/` — синхронизация 1С, расчёты, Excel.
- `scripts/` — bat-файлы для Windows.

## Проверка настройки
После запуска:
1. Откройте бот → `/start`.
2. Администратор должен увидеть меню и возможность регистрации дистрибьютера.
3. Дистрибьютер/продавец регистрируются по ИНН + паролю + ФИО.
