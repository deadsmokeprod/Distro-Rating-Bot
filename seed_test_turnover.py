"""
Загрузка тестовых данных по продажам (обороты) в SQLite, как при выгрузке из 1С.
Запуск: python seed_test_turnover.py
"""
from __future__ import annotations

import asyncio
from datetime import datetime

from app.config import load_config
from app.db.sqlite import init_db, upsert_chz_turnover


def _parse_period(s: str) -> str:
    """Из '01.01.2026 0:00:00' -> '2026-01-01'."""
    try:
        dt = datetime.strptime(s.strip().split()[0], "%d.%m.%Y")
        return dt.strftime("%Y-%m-%d")
    except (ValueError, IndexError):
        return s.strip()


def _parse_volume(s: str) -> float:
    """'3,000' -> 3.0, '' -> 0.0."""
    if not s or not s.strip():
        return 0.0
    return float(s.strip().replace(",", "."))


# Порядок: Период, ТипОперации, Номенклатура, ОбъемТоваров, ОбъемЧастичнойРеализации,
#          ПродавецИНН, ПродавецНаименование, ПокупательИНН, ПокупательНаименование
TEST_ROWS_RAW = [
    (
        "01.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(022)ТМ "MJOLNIR" Медовуха облепиховая"Огненный Великан Сурт" барная версия 0.5л',
        "3,000",
        "",
        "4611012110",
        "ИП АЛЕКСЕЕВА ОЛЬГА ВАЛЕРЬЕВНА",
        "772094106945",
        "ИП АЛЕКСЕЕВ МАКСИМ СЕРГЕЕВИЧ",
    ),
    (
        "01.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(105) Медовуха пихта-манго "Хель Владычица" Барная версия 0.5л',
        "1,500",
        "",
        "4611012110",
        "ИП АЛЕКСЕЕВА ОЛЬГА ВАЛЕРЬЕВНА",
        "772094106945",
        "ИП АЛЕКСЕЕВ МАКСИМ СЕРГЕЕВИЧ",
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(001) Медовуха "Классическая" пастеризованная нефильтрованная неосветленная натуральная 0.5',
        "6,000",
        "",
        "4611012110",
        "ЛЕТОС ООО",
        "745901731578",
        "ИП БОГДАНОВА ЛЯЙСАН АЛИКОВНА",
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(001) Медовуха "Классическая" пастеризованная нефильтрованная неосветленная натуральная 0.5',
        "6,000",
        "",
        "4611012110",
        "ЛЕТОС ООО",
        "663231694050",
        "ИП СУСЛОВ ПАВЕЛ ВЛАДИМИРОВИЧ",
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(001) Медовуха "Классическая" пастеризованная нефильтрованная неосветленная натуральная 0.5',
        "6,000",
        "",
        "4611012110",
        "ЛЕТОС ООО",
        "667208037550",
        "ИП ОСТАФЬЕВ МИХАИЛ ЮРЬЕВИЧ",
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(001) Медовуха "Классическая" пастеризованная нефильтрованная неосветленная натуральная 0.5',
        "6,000",
        "",
        "4611012110",
        "ЛЕТОС ООО",
        "668606316330",
        "ИП ПАСАЖЕННИКОВА МАРИНА АНАТОЛЬЕВНА",
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(001) Медовуха "Классическая" пастеризованная нефильтрованная неосветленная натуральная 0.5',
        "6,000",
        "",
        "4611012110",
        "ЛЕТОС ООО",
        "667351769949",
        "ИП КОЛБИН АЛЕКСАНДР ВАДИМОВИЧ",
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(001) Медовуха "Классическая" пастеризованная нефильтрованная неосветленная натуральная 0.5',
        "6,000",
        "",
        "4611012110",
        "ЛЕТОС ООО",
        "667000337308",
        "ИП ШАШМУРИНА ОЛЬГА ГРИГОРЬЕВНА",
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(102)ТМ "MJOLNIR" Сидр фруктовый яблочный "Бессмертие Идунн" Барная версия 0.5л',
        "0,500",
        "",
        "4611012110",
        "ИП КОРОЛЁВ ИЛЬЯ АНДРЕЕВИЧ",
        "3662162993",
        'ООО "ОЛИМП"',
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(104)ТМ "MJOLNIR" Сидр фруктовый грушевый "Проделки Локи" Барная версия 0.5л',
        "0,500",
        "",
        "4611012110",
        "ИП КОРОЛЁВ ИЛЬЯ АНДРЕЕВИЧ",
        "3662162993",
        'ООО "ОЛИМП"',
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(062) Медовуха "Мид вайн" пастеризованная нефильтрованная неосветленная натуральная 0.5',
        "6,000",
        "",
        "4611012110",
        "ЛЕТОС ООО",
        "025610179664",
        "ИП ТОКАРЕВА ЕВГЕНИЯ АНАТОЛЬЕВНА",
    ),
    (
        "02.01.2026 0:00:00",
        "Передача между УОТ",
        'бут(062) Медовуха "Мид вайн" пастеризованная нефильтрованная неосветленная натуральная 0.5',
        "6,000",
        "",
        "4611012110",
        "ЛЕТОС ООО",
        "450140044339",
        "ИП КУЗНЕЦОВА ОКСАНА ЛЕОНИДОВНА",
    ),
]


def _raw_to_row(raw: tuple) -> dict:
    (
        period_str,
        type_operation,
        nomenclature,
        volume_goods_str,
        volume_partial_str,
        seller_inn,
        seller_name,
        buyer_inn,
        buyer_name,
    ) = raw
    return {
        "period": _parse_period(period_str),
        "type_operation": type_operation.strip(),
        "nomenclature": nomenclature.strip(),
        "volume_goods": _parse_volume(volume_goods_str),
        "volume_partial": _parse_volume(volume_partial_str),
        "seller_inn": seller_inn.strip(),
        "seller_name": seller_name.strip(),
        "buyer_inn": buyer_inn.strip(),
        "buyer_name": buyer_name.strip(),
    }


async def main() -> None:
    config = load_config()
    await init_db(config.db_path)
    rows = [_raw_to_row(r) for r in TEST_ROWS_RAW]
    n = await upsert_chz_turnover(config.db_path, rows)
    print(f"Записано записей по оборотам: {n}")


if __name__ == "__main__":
    asyncio.run(main())
