# Stage 4: анализ и применимость

Дата: 2026-02-18  
Связанные документы:
- `docs/new-stack-original-2026-02-18.md`
- `docs/business-requirements-2026-02-18-stage4.md`
- `docs/implementation-checklist4.md`

---

## 1) Текущая база (baseline)

По коду уже есть:

1. Ролевое меню (`seller/rop`, `manager/admin`) и server-side RBAC checks.
2. Рассылка с target mode (`all`, `my_orgs`, `org`) и аудитом.
3. Поддержка с FSM + token + антидубликат.
4. Споры/финансы/merge с 2-step confirm, местами через delay timer.
5. Единое активное inline-меню (`ActiveInlineMenuFilter` + helpers).

Итог: большая часть Stage 4 реализуема на текущем фундаменте без ломки архитектуры.

---

## 2) Анализ применимости по требованию

## BR-07 Рассылки 2.0

Применимость: **высокая**.

- Текущий flow уже FSM-основанный; добавление медиа делается через `copy_message`/типизированные send-ветки.
- Ограничение "всем только admin" - простая роль-проверка в шаге выбора target и финальной отправке.
- Риски: пересылка некоторых сервисных/ограниченных типов Telegram; нужно graceful fallback.

Решение:
- на шаге `message` принимать не только `text`, но и media;
- хранить в state `source_chat_id + source_message_id + content_type`;
- при отправке использовать `copy_message` как основной путь.

## BR-08 Скрижали и связь с менеджером

Применимость: **высокая**.

- Структура меню уже модульная (`app/keyboards/seller.py` + seller handlers).
- Support-flow уже есть и может быть переиспользован с другим адресатом.

Риски:
- у пользователя может не быть manager-контакта (крайние случаи с legacy-данными);
- важно не смешать канал в техподдержку и в менеджера.

Решение:
- отдельный callback namespace для manager-help;
- общий антиспам-механизм, но отдельные state keys;
- fallback-текст, если manager недоступен.

## BR-09 Таймеры -> cooldown

Применимость: **средняя/высокая**.

- Локально реализуемо через `is_rate_limited` и ключи вида `action:user:entity`.
- Наиболее чувствительные ветки: dispute open/resolve, sale confirm, withdraw confirm, merge execute.

Риски:
- слишком жесткие лимиты ухудшат UX;
- слишком мягкие не снимут риск спама.

Решение:
- отказаться от sleep-триггеров в confirm;
- добавить cooldown после успешного/неуспешного критичного submit;
- вводить точечно, с минимальным набором по high-risk действиям.

## BR-10 Уведомления о результате спора

Применимость: **высокая**.

- Все данные для адресатов уже есть в `sales_claims`/`sale_disputes`.
- Точка интеграции: `resolve_dispute` flow в seller handler.

Риски:
- дубли уведомлений при повторных callback;
- отправка не тому адресату при race.

Решение:
- отправка только после успешного `resolve_dispute`;
- формирование получателей из текущей записи спора/клейма;
- idempotent guard по статусу спора.

## BR-11 ID + ФИО

Применимость: **высокая**.

- В большинстве мест ФИО уже есть в БД; нужен системный проход по текстам и клавиатурам.

Риски:
- слишком длинные labels в inline (ограничение Telegram по длине кнопок).

Решение:
- для кнопок: короткая форма `ФИО | ID` + safe shorten;
- для карточек: полная форма.

## BR-12 Группировка продаж

Применимость: **средняя** (крупное изменение).

- Это архитектурный слой над текущими `turnover` и `sales_claims`.
- Нужна миграция и перепривязка части dispute-логики к "группе" вместо "single turnover row".

Риски (высокие):
- регресс фиксации/споров/начислений;
- ошибки консистентности между группой и деталями;
- деградация производительности при плохих индексах.

Рекомендация внедрения:
1. Сначала read-only группировка в UI (без изменения write-path).
2. Затем group-level confirm/dispute в отдельном этапе с миграцией.
3. Только после smoke/e2e включать default-flow.

## BR-13 Главный экран и стилистика

Применимость: **высокая**.

- Локальные текстовые изменения.
- Держать лимит стилизации ~30% по ключевым user-facing текстам.

Риски:
- потеря ясности формулировок.

Решение:
- сначала собрать словарь tone-guide;
- не менять технические сообщения ошибок и критичные инструкции.

---

## 3) План безопасного внедрения (без ломки текущего)

Предлагаемый порядок:

1. BR-07 (ограничение "всем только admin" + медиа-рассылка).
2. BR-08 (скрижали + manager-help).
3. BR-09 (уборка delay timers, внедрение cooldown в high-risk actions).
4. BR-10 и BR-11 (уведомления + информативность ФИО/ID).
5. BR-12 (двухфазно: read-only grouping -> write-path grouping).
6. BR-13 (стилистика и главный экран).

Контрольные меры:

- Перед BR-12: backup БД и отдельный smoke.
- После каждого подэтапа: compileall + lints + focused smoke.
- Никаких ослаблений RBAC/tenant/private filters.

---

## 4) Тест-матрица (минимум)

1. Рассылка admin:
   - "всем" доступна;
   - текст и медиа отправляются;
   - по org работает для любой org.
2. Рассылка manager:
   - "всем" недоступна;
   - видит только свои org;
   - попытка выбрать чужую org блокируется.
3. Скрижали:
   - новые пункты видны seller/rop;
   - "Помощь с приложением" и "Правила" перенесены корректно.
4. Связь с менеджером:
   - обращение уходит manager своей org;
   - антиспам/идемпотентность работают.
5. Cooldown:
   - нет artificial wait таймера;
   - повторное действие блокируется на заданное окно.
6. Споры:
   - результат notify отправляется релевантным участникам.
7. Информативность:
   - в спорах/списках нет "только ID" без имени.
8. Группы продаж:
   - список показывает группы;
   - карточка раскрывает детализацию;
   - подтверждение/спор работают по группе.

---

## 5) Итог применимости

Этап применим на текущем коде.  
Критический риск - BR-12 (группировка продаж), его нужно внедрять поэтапно и с усиленным регрессом.  
Остальные пункты можно реализовывать инкрементально без разрушения существующих сценариев.
