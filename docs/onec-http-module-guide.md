# 1С HTTP-модуль для интеграции с ботом

Этот документ фиксирует стабильную часть интеграции с 1С, которую можно использовать как эталон при поддержке и диагностике.

## Назначение

Бот запрашивает обороты из 1С по HTTP-сервису:

- метод: `POST`
- endpoint: `/hs/BotAPI/chz_turnover`
- вход: период (`startDate`, `endDate`) + `operationType`
- выход: `ok/count/rows` для загрузки в `chz_turnover`

## Рекомендуемая архитектура в 1С

- HTTP-сервис `BotAPI` создается в основной конфигурации (чтобы корректно публиковался).
- В модуле HTTP-сервиса используется тонкий прокси-вход `botapiМетод1()`.
- Основная бизнес-логика лежит в расширении (например, общий модуль `BotAPI_Impl`, серверный).

Это позволяет не ломать типовую конфигурацию и централизовать поддержку.

## Публикация и URL

Итоговый URL:

`http(s)://<WEB_HOST>/<PUBLISH_NAME>/hs/<HTTP_SERVICE>/<URL_TEMPLATE>`

Пример:

`http://192.168.0.217/1cerp_copy/hs/BotAPI/chz_turnover`

Где:

- `<PUBLISH_NAME>`: имя публикации (виртуальный каталог),
- `<HTTP_SERVICE>`: `BotAPI`,
- `<URL_TEMPLATE>`: `chz_turnover`.

## Контракт API

### Запрос

- Метод: `POST`
- `Content-Type: application/json`
- Обязательные поля: `startDate`, `endDate` (формат `YYYY-MM-DD`)
- Опционально: `operationType` (если не передан, модуль 1С может подставлять дефолт)

Пример:

```json
{
  "startDate": "2026-02-01",
  "endDate": "2026-02-18",
  "operationType": "Передача между УОТ"
}
```

### Успешный ответ (`200`)

```json
{
  "ok": true,
  "count": 1,
  "rows": [
    {
      "Период": "2026-02-12",
      "ТипОперации": "Передача между УОТ",
      "Номенклатура": "Товар",
      "ОбъемТоваров": 3.0,
      "ОбъемЧастичнойРеализации": 0.0,
      "ПродавецИНН": "7700000000",
      "ПродавецНаименование": "ООО Продавец",
      "ПокупательИНН": "7800000000",
      "ПокупательНаименование": "ООО Покупатель"
    }
  ]
}
```

### Ошибки

- `400`: некорректные параметры (нет дат, неверный формат, период > 60 дней, не найден `ТипОперации`)
- `401`: проблема авторизации (Basic Auth/пользователь/настройки публикации)
- `403`: недостаточно прав
- `404`: неверный URL публикации/сервиса/шаблона
- `500`: ошибка внутри модуля 1С

Формат ошибки:

```json
{ "ok": false, "error": "..." }
```

При ошибке поиска типа операции может возвращаться:

```json
{
  "ok": false,
  "error": "ТипОперации не найден по представлению: ...",
  "availableOperationTypes": ["..."]
}
```

## Пользователь 1С и права

Рекомендуется отдельный пользователь (например, `bot_api`) с минимальными правами:

- вызов HTTP-сервиса `BotAPI`,
- чтение `РегистрНакопления.ЧЗ_Оборачиваемость`,
- чтение связанных объектов (`Номенклатура`, `Продавец`, `Покупатель`),
- корректные ограничения RLS (иначе возможен пустой `rows` или пустой список операций).

## Логика обработчика в 1С (кратко)

1. Считать и распарсить JSON.
2. Проверить `startDate/endDate` и период (обычно ограничение 60 дней).
3. Найти `ТипОперации` по строковому представлению (с нормализацией строк).
4. Выполнить запрос к `ЧЗ_Оборачиваемость` за период и по найденному типу.
5. Вернуть `ok/count/rows` в JSON.

## Что важно для текущего бота

- Бот отправляет `startDate/endDate` и `operationType` (дополнительно может отправлять `ТипОперации`).
- Для Basic Auth используются `.env`:
  - `ONEC_USERNAME`
  - `ONEC_PASSWORD`
- Текущий практический кейс диагностики:
  - `401` устранен после передачи корректных Basic credentials;
  - `400 ТипОперации не найден` означает, что нужно уточнить фактическое представление операции и/или права пользователя API в 1С.

## Быстрый чек-лист диагностики

1. Проверить URL публикации и доступность endpoint.
2. Проверить auth-режим (анонимный/Basic) и валидность credentials.
3. Проверить, что модуль принимает `startDate/endDate` в `YYYY-MM-DD`.
4. Проверить `operationType` (точное представление из 1С).
5. Проверить права `bot_api` и RLS.
6. Проверить ответ на наличие `availableOperationTypes` и текст `error`.
