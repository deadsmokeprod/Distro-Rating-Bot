# Stage 3: baseline, test matrix, and 1C test contour

Дата: 2026-02-18  
Цель: закрыть Этап 0 из `docs/implementation-checklist3.md`.

---

## 1) Baseline текущего поведения (до доработок Stage 3)

## BR-01 (одно активное inline-меню)

Текущее состояние:
- Централизованного механизма "single active inline menu" нет.
- Inline-меню создаются в разных handler-функциях точечно; единый реестр "последнего активного меню" отсутствует.
- Устаревшие callback могут оставаться в чате до удаления вручную.

Вывод baseline:
- Требование BR-01 **не реализовано** системно.

## BR-02 (1С интеграция, 401, корректность импорта)

Текущее состояние:
- Запросы выполняются через `app/services/onec_client.py` (`fetch_chz_turnover`).
- Поддерживаются оба ключа операции: `operationType` и `ТипОперации`.
- При `response.status != 200` формируется ошибка `OnecClientError("1С ответил {status}: ...")`.
- Менеджерский flow выводит пользователю ошибку вида `❌ Ошибка 1С: ...`.

Вывод baseline:
- Логика обработки ошибки есть, но проблема `401` воспроизводится (см. раздел 3).

## BR-03 (поддержка: текст -> confirm -> 60s -> send)

Текущее состояние:
- При нажатии поддержки сейчас сразу отправляется нотификация support user (callback `support_request_callback` в `app/handlers/start.py`).
- Шаги: ввод текста обращения, подтверждение, таймер 60 сек — отсутствуют.

Вывод baseline:
- Требование BR-03 **не реализовано**.

## BR-04 (правила не показывать во время регистрации)

Текущее состояние:
- `seller_start_menu()` содержит `SELLER_RULES` уже на старте (`app/keyboards/seller.py`).

Вывод baseline:
- Требование BR-04 **не реализовано**.

## BR-05 (кнопки только по роли)

Текущее состояние:
- `seller_main_menu()` содержит пункты, предназначенные только для части ролей (например, модерация споров и "Мои сотрудники").
- `manager_main_menu()` показывает admin-only функции (`Слияние компаний`, `Личные цели (админ)`), хотя часть ограничений стоит в handler-ах.
- На backend есть проверки прав в critical местах, но UI-видимость не полностью role-aware.

Вывод baseline:
- Частично реализовано, требуется доведение UI до строгого RBAC.

## BR-06 (рассылка по выбранной компании)

Текущее состояние:
- Есть рассылка "всем продавцам" и "продавцам моих компаний".
- Выбора конкретной компании в flow рассылки нет.

Вывод baseline:
- Требование BR-06 **не реализовано**.

---

## 2) Тест-матрица BR-01..BR-06 (этап внедрения)

Формат кейсов: `ID | Требование | Сценарий | Ожидаемый результат | Тип`.

- T1 | BR-01 | Открыть inline-меню A, затем inline-меню B | Меню A деактивировано/удалено, активно только B | Happy
- T2 | BR-01 | Нажать кнопку из устаревшего меню A | Операция не выполняется, пользователь получает безопасное сообщение | Negative
- T3 | BR-01 | Повторно открыть то же меню | Нет дублей и ошибок Telegram API | Resilience

- T4 | BR-02 | Sync "текущий месяц" с корректной auth | Успешный ответ 200, данные импортированы | Happy
- T5 | BR-02 | Sync "кастомный период" с корректной auth | Успешный импорт, корректные counters | Happy
- T6 | BR-02 | Sync при неверных auth/правах | Понятная ошибка без утечки секретов | Negative
- T7 | BR-02 | Повторный sync с теми же данными | Нет дублей, upsert идемпотентен | Consistency

- T8 | BR-03 | Пользователь вводит текст, подтверждает, ждет 60с, отправляет | Обращение доставлено, 1 отправка | Happy
- T9 | BR-03 | Нажатие "Отправить" до таймера | Отправка недоступна | Negative
- T10 | BR-03 | Многократные клики после таймера | Нет дублей обращений | Anti-spam

- T11 | BR-04 | Новый пользователь в `/start` и регистрации | Кнопка/действие правил отсутствует | Happy
- T12 | BR-04 | Зарегистрированный пользователь в главном меню | Правила доступны | Regression

- T13 | BR-05 | Проверка меню SELLER | Только seller-действия, без rop/admin-only | RBAC
- T14 | BR-05 | Проверка меню ROP | Есть rop-действия, нет manager/admin-only | RBAC
- T15 | BR-05 | Проверка меню MANAGER | Нет admin-only UI-пунктов | RBAC
- T16 | BR-05 | Проверка меню ADMIN | Видны admin-функции | RBAC
- T17 | BR-05 | Ручной callback недоступной функции | Серверный запрет, без эффекта | Security

- T18 | BR-06 | Manager выбирает конкретную свою компанию и рассылает | Получатели только в выбранной компании | Happy
- T19 | BR-06 | Manager пытается выбрать чужую компанию | Доступ запрещен | Security
- T20 | BR-06 | Admin выбирает любую компанию | Рассылка по выбранной компании выполняется | Happy

---

## 3) Диагностика 1С (Этап 0: воспроизведение и первичный анализ)

Проверенный endpoint:
- `http://192.168.0.217/1cerp_copy/hs/BotAPI/chz_turnover`

Проверки из среды разработки:

1. POST без auth (JSON тело с датами и operationType)
   - Результат: `status=401`
2. POST с тестовым Basic Authorization header
   - Результат: `status=401`

Вывод:
- Ошибка `401` **воспроизводится вне бота**, значит проблема подтверждается на границе доступа к 1С (auth/публикация/права), а не только внутри Telegram flow.

Гипотезы (приоритет):
1. Нужны корректные `ONEC_USERNAME/ONEC_PASSWORD` для опубликованного HTTP-сервиса.
2. На публикации 1С отключен анонимный доступ и/или включен иной auth режим.
3. Пользователь API не имеет прав на вызов HTTP-сервиса/чтение регистра.

Что готово для следующего этапа:
- воспроизводимый сценарий диагностики 401;
- список проверок для 1С-админа;
- подтверждение, что bot-side обработка ошибки работает, но auth с 1С не проходит.

---

## 4) Безопасный тестовый контур и данные (готовность Stage 3)

Контур:
- Использовать отдельную test-БД (`DB_PATH`) и отдельный test-бот токен при отладке новых flow.
- Не логировать секреты (`BOT_TOKEN`, `ONEC_PASSWORD`) и персональные реквизиты.

Тестовые данные:
- Организации:
  - Org A (manager-owned)
  - Org B (admin-visible, manager-inaccessible)
- Пользователи:
  - ADMIN, MANAGER, ROP, SELLER (по 1-2 на компанию)
- Продажи:
  - Набор оборотов с пересечением buyer/seller для проверки споров и рассылок.

Готовность:
- Тест-матрица составлена (раздел 2).
- Контур для безопасного прогона определен.
- Базовая диагностика 1С выполнена.

