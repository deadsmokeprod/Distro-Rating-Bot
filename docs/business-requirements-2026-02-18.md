# Оригинал бизнес-требований (новый этап доработок)

Дата: 2026-02-18  
Статус: Draft v1 (к реализации)  
Основание: новые бизнес-запросы заказчика + текущая архитектура бота + требования безопасности из предыдущих этапов.

---

## 1) Контекст и цель

Бот уже содержит зрелый контур RBAC, споры, финансы, интеграцию с 1С, push-уведомления и аудит. Новый этап должен:

1. Упростить UX inline-меню (одно активное меню).
2. Восстановить работоспособность интеграции с 1С (ошибка 401) и подтвердить корректность импорта в БД.
3. Усилить антиспам в обращениях в техподдержку (таймер + подтверждение).
4. Изменить UX регистрации: не показывать "Правила" в процессе регистрации.
5. Довести RBAC-видимость кнопок до строго ролевой.
6. Доработать рассылку по выбранной компании с корректной областью доступа для Manager/Admin.

---

## 2) Источники требований

- Новые "хотелки" заказчика (6 пунктов).
- Текущие контрольные документы:
  - `docs/implementation-checklist.md`
  - `docs/implementation-checklist2.md`
- Текущая кодовая база (`bot.py`, `app/handlers/*`, `app/keyboards/*`, `app/services/*`, `app/db/sqlite.py`).

---

## 3) Сквозные ограничения и правила безопасности

Ниже требования обязательны для всех пунктов этапа:

1. **RBAC-first**: никакая функция не должна быть доступна через обход callback/data, даже если кнопка скрыта.
2. **Tenant isolation**: любые выборки по организациям/пользователям должны фильтроваться по области доступа менеджера или админа.
3. **Private-only**: поведение private-chat фильтра не ослабляется.
4. **Anti-abuse**: для новых подтверждений/таймеров не допускать флуд и гонки (идемпотентность на повторных нажатиях).
5. **Auditability**: критичные действия и ошибки интеграции 1С должны быть трассируемы (audit/log).
6. **Backward compatibility**: не ломать текущие активные сценарии регистрации, продаж, споров, финансов и целей.

---

## 4) Функциональные бизнес-требования

## BR-01. Единое активное inline-меню

**Проблема:** в чатах остаются старые сообщения с inline-кнопками; пользователи нажимают устаревшие действия.  
**Требование:** при открытии нового меню с inline-кнопками предыдущее активное меню должно деактивироваться.

### Ожидаемое поведение

1. Для каждого пользователя и сценарного контекста хранится "последнее активное меню".
2. Перед показом нового inline-меню:
   - предыдущее меню удаляется или редактируется в неактивный вид;
   - новое становится единственным активным.
3. Повторное нажатие по устаревшему callback не выполняет бизнес-действие.

### Acceptance Criteria

- В чате в каждый момент времени остается не более одного актуального inline-меню для выбранного потока.
- Нажатие по старой кнопке не вызывает необратимых операций.
- Нет ошибок Telegram API, приводящих к поломке сценария (удалено сообщение, message not modified и т.п.).

---

## BR-02. Интеграция с 1С: диагностика 401 и валидация импорта

**Проблема:** при обновлении базы менеджером бот получает `401` от 1С.  
**Требование:** провести техническую диагностику, восстановить успешную авторизацию, и подтвердить корректность записи данных из 1С в SQLite.

### Обязательные задачи диагностики

1. Подтвердить URL и доступность endpoint:
   - `http://192.168.0.217/1cerp_copy/hs/BotAPI/chz_turnover`
2. Проверить режим аутентификации на стороне 1С (анонимный доступ vs Basic Auth).
3. При необходимости настроить `ONEC_USERNAME` / `ONEC_PASSWORD`.
4. Зафиксировать в логах:
   - HTTP status;
   - sanitized причину ошибки (без утечки секретов);
   - параметры периода/режима запроса.

### Обязательные задачи по корректности данных

1. Проверить контракт JSON-ответа 1С (поля, типы, даты, объемы).
2. Валидировать преобразование полей в `upsert_chz_turnover`.
3. Проверить идемпотентность апсерта, `inserted_count`, `affected_seller_inns`, `affected_company_group_ids`.
4. Проверить ручной и плановый sync.

### Acceptance Criteria

- Запросы "текущий месяц" и "кастомный период" проходят без 401 при корректных настройках.
- При некорректной auth-конфигурации пользователь получает понятную ошибку + actionable hint.
- Новые строки корректно загружаются в `chz_turnover`; повторная загрузка не дублирует данные.

---

## BR-03. Техподдержка: текст + подтверждение + таймер 60 сек

**Проблема:** нужен антиспам-флоу для обращений в поддержку.  
**Требование:** пользователь сначала вводит текст обращения, затем подтверждает намерение, затем после 60 секунд получает возможность отправить.

### Целевой сценарий

1. Пользователь выбирает "Написать в поддержку".
2. Бот просит ввести текст обращения.
3. После ввода показывает предпросмотр + кнопка "Подтвердить".
4. После подтверждения запускается таймер 60 сек.
5. По истечении таймера активируется кнопка "Отправить".
6. Нажатие "Отправить" доставляет обращение в текущий канал поддержки.

### Acceptance Criteria

- До истечения 60 сек отправка невозможна.
- Повторные нажатия в течение таймера не создают дубликаты.
- Отмена/назад корректно очищает состояние FSM.
- Старый механизм адресации в поддержку сохраняется (username или support_user_id).

---

## BR-04. Регистрация: скрыть "Правила" до завершения регистрации

**Проблема:** в процессе регистрации не нужно показывать загрузку/выдачу правил.  
**Требование:** для незарегистрированного пользователя в flow регистрации не отображать кнопку/действие "Правила".

### Acceptance Criteria

- На шагах регистрации (ИНН/роль/пароль/ФИО/никнейм) нет выдачи rules-файла.
- После успешной регистрации доступ к "Правилам" в роли остается.

---

## BR-05. Строгая ролевая видимость кнопок меню

**Проблема:** кнопки не должны быть видны ролям, которым функции недоступны.  
**Требование:** все reply/inline-меню строятся строго по роли и полномочиям.

### Acceptance Criteria

- `SELLER`, `ROP`, `MANAGER`, `ADMIN` видят только допустимые пункты.
- Для скрытых функций остается server-side защита (нельзя выполнить вручную callback).
- После изменения статуса/роли меню актуализируется.

---

## BR-06. Рассылка по выбранной компании (Manager/Admin)

**Проблема:** нужна адресная рассылка в сотрудников конкретной компании.

### Требование

Добавить режим рассылки "по компании":

- **Manager**: видит только свои компании и может выбрать одну из них.
- **Admin**: видит все компании и выбирает любую.

### Acceptance Criteria

- Выбор компании обязателен для режима "по компании".
- Получатели корректно ограничены по компании/активному статусу/допустимым ролям.
- Нет утечек рассылки в чужие организации для Manager.

---

## 5) Нефункциональные требования

1. Не увеличивать чувствительность к гонкам в callback/FSM.
2. Ошибки Telegram API обрабатывать мягко (без падения потока пользователя).
3. Логи не должны содержать секреты (`BOT_TOKEN`, `ONEC_PASSWORD`, реквизиты).
4. Для новых сценариев — минимальный регрессионный smoke по ролям.

---

## 6) Критерии приемки этапа целиком

Этап принимается, если:

1. Все BR-01..BR-06 выполнены и закрыты тест-кейсами.
2. Интеграция с 1С работает в ручном режиме обновления базы.
3. Не сломаны существующие сценарии (регистрация, фиксация, споры, финансы, цели, merge/inn).
4. Чек-лист реализации закрыт с привязкой к коду и проверкам.

---

## 7) Риски и допущения

1. `401` может быть внешней проблемой публикации 1С/прав доступа, а не только кодом бота.
2. В части удаления старых inline-меню Telegram может возвращать "message not found/modified"; нужно безопасно игнорировать неопасные ошибки.
3. Для антиспама поддержки нужно синхронизировать UX и rate-limit, чтобы не ухудшить пользовательский опыт.

