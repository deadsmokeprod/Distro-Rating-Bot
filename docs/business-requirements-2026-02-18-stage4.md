# Бизнес-требования (Stage 4): рассылки, помощники, антиспам, UX-стиль

Дата: 2026-02-18  
Статус: к реализации  
Основание: `docs/new-stack-original-2026-02-18.md`

---

## 1) Цель этапа

Доработать текущий прод-контур без регрессий:

1. Расширить рассылку (типы контента, ограничения по ролям, таргетинг по компании).
2. Добавить блок "Скрижали" и канал "Связаться с менеджером" с антиспамом.
3. Заменить confirm-таймеры ожидания на cooldown повторного действия.
4. Добавить уведомления по результатам споров.
5. Повысить информативность UI (ID + ФИО в ключевых местах).
6. Перейти на группировку продаж по `(дата, контрагент)` с детальной раскладкой по номенклатуре.
7. Обновить главный экран и частично стиль текстов (до 30% изменений, без потери понятности).

---

## 2) Сквозные требования безопасности и совместимости

Обязательны для всех BR ниже:

1. **RBAC-first**: скрытие кнопки не заменяет проверку прав в handler.
2. **Tenant isolation**: manager работает только со своими org; admin - со всеми.
3. **Private-only** не ослабляется.
4. **Anti-abuse**: для новых/переделанных действий есть idempotency и cooldown.
5. **No-regression**: не ломаем действующие flow регистрации, фиксации, споров, финансов, целей.
6. **Safe logs**: без секретов и лишних персональных данных.

---

## 3) Функциональные требования

## BR-07. Рассылки 2.0

### Требования

1. Рассылка поддерживает все основные типы контента Telegram: текст, фото, видео, voice, video note, document, animation, sticker, audio, contact, location (где применимо).
2. Режим "По выбранной компании" доступен:
   - manager: только свои компании;
   - admin: все компании.
3. Режим "Всем продавцам" доступен только admin.
4. Таргетинг и отправка не допускают выхода за область доступа.

### Acceptance Criteria

- Message-forward/copy работает для перечисленных типов, которые Telegram позволяет пересылать.
- Manager не может отправить "всем" и не видит чужие компании.
- Audit фиксирует actor, target mode, org (если есть), recipients, sent.

---

## BR-08. Блок "Скрижали продавца" и обращение к менеджеру

### Требования

1. Добавить меню "Скрижали продавца" (или эквивалентную кнопку-узел), внутри:
   - "Скрижали в помощь" (советы по увеличению медкоинов и активности в боте);
   - "Помощь с приложением" (бывшая кнопка "Помощь");
   - "Правила и рекомендации" (перенос из текущей точки меню).
2. Добавить "Помощь в продажах" с текстом и кнопкой "Связаться с менеджером".
3. "Связаться с менеджером" работает как поддержка (FSM + confirm + anti-spam), но адресат - manager, владелец org пользователя.

### Acceptance Criteria

- Для seller/rop доступны новые пункты в "Скрижалях".
- Обращение уходит именно менеджеру своей организации/группы, не в общую поддержку.
- Есть защита от дубликатов/повторов/устаревших callback.

---

## BR-09. Антиспам без ожидания подтверждения

### Требования

1. Убрать confirm-delay таймеры ожидания для операций, где они есть.
2. Оставить двухэтапное подтверждение, но ввести cooldown повторного действия.
3. Добавить cooldown на "фиксацию продаж".
4. Пройти по потенциально рискованным веткам (споры, финансы, рассылка, support/manager-help и т.п.) и поставить разумные ограничения без "переусердствования".

### Acceptance Criteria

- Подтверждение доступно сразу (без sleep-ожидания).
- Повтор одного и того же действия в окне cooldown блокируется корректно.
- Не ухудшается UX в легитимных сценариях.

---

## BR-10. Уведомления по результатам спора

### Требования

При approve/reject спора отправлять уведомления релевантным участникам (инициатору и/или участнику, чья продажа была предметом спора; при необходимости - модератору РОП).

### Acceptance Criteria

- После решения спора участники получают понятный результат (approve/reject, кто решил, по какому спору/продаже).
- Повторных дубликатов уведомлений нет.

---

## BR-11. Информативность идентификации пользователей

### Требования

Во всех критичных местах, где сейчас виден только `ID`, добавить человеко-понятное представление:
- `ФИО (или fallback) + ID`.

Приоритет: споры, модерация, карточки/списки сотрудников, аудитные пользовательские сообщения.

### Acceptance Criteria

- В UI нет "безымянных" участников в ключевых действиях.
- Если ФИО пусто, есть понятный fallback (`ID NNN`).

---

## BR-12. Группировка продаж `(дата, контрагент)`

### Требования

1. На уровне БД и доменной логики ввести группировку продаж:
   - ключ: `period_date + buyer` (buyer INN, опционально buyer_name).
2. В списках фиксации/споров/связанных сценариях отображать группу как одну позицию.
3. При открытии группы показывать детализацию по номенклатуре как read-only.
4. Подтверждение фиксации/оспаривания выполняется на уровне группы.

### Acceptance Criteria

- Пользователь работает с группой, а не с каждой строкой номенклатуры.
- Детализация доступна в карточке группы.
- Существующие механики начислений/споров/идемпотентности сохраняют корректность.

---

## BR-13. Обновление главного экрана и стилистики

### Требования

1. Добавить на главный экран краткий мотивационный текст в легионерском стиле.
2. Провести частичный стиль-рефактор текста/эмодзи:
   - тематика "легион + медоварня";
   - не более 30% UI-текстов;
   - приоритет на ясность и полезность.

### Acceptance Criteria

- Тексты читаемы и однозначны.
- Тон обновлен умеренно, без перегруза.

---

## 4) Нефункциональные требования

1. Миграции БД обратимо безопасны (backup перед изменениями).
2. Для крупных изменений (BR-12) - поэтапный rollout и smoke до включения по умолчанию.
3. Все новые FSM/callback ветки устойчивы к stale-message и повторным нажатиям.
4. В логах нет токенов/паролей/сырого чувствительного payload.

---

## 5) Критерии приемки этапа целиком

Этап считается принятым, если:

1. Закрыты BR-07..BR-13 с привязкой к коду и проверкам.
2. Пройден регресс по ролям (`ADMIN`, `MANAGER`, `ROP`, `SELLER`).
3. Не сломаны действующие сценарии Stage 3.
4. Обновлены `README.md` и чек-лист реализации.
